@inherits LayoutComponentBase
@inject HttpClient Http
@inject IFirebaseService FirebaseService
@inject IGeminiService GeminiService
@inject IJSRuntime JSRuntime
@inject NavigationManager NavigationManager

@if (isInitialized)
{
    @if (currentUser == null)
    {
        <div class="d-flex flex-column align-items-center justify-content-center bg-white" style="height: 100vh;">
            <div class="modern-card text-center p-5 shadow-lg animate__animated animate__fadeIn" style="max-width: 500px; border-radius: 20px;">
                <div class="mb-4">
                    <i class="bi bi-person-lock text-primary" style="font-size: 5rem;"></i>
                </div>
                <h1 class="fw-bold mb-3">Witaj w Home Assistant</h1>
                <p class="text-muted mb-4 fs-5">Zaloguj się kontem Google, aby uzyskać dostęp do swojego panelu domowego.</p>
                <button class="btn btn-primary btn-lg px-5 shadow-sm rounded-pill py-3 d-flex align-items-center justify-content-center mx-auto" @onclick="Login">
                    <i class="bi bi-google me-3 fs-5"></i> <span>Zaloguj przez Google</span>
                </button>
            </div>
        </div>
    }
    else if (!isWhitelisted)
    {
        <div class="d-flex flex-column align-items-center justify-content-center bg-light" style="height: 100vh;">
            <div class="modern-card text-center p-5 shadow-lg border-danger animate__animated animate__shakeX" style="max-width: 500px; border-radius: 20px;">
                <div class="mb-4">
                    <i class="bi bi-shield-exclamation text-danger" style="font-size: 5rem;"></i>
                </div>
                <h2 class="fw-bold mb-3">Brak uprawnień</h2>
                <p class="text-muted mb-4 fs-5">Twoje konto (<strong>@currentUser.Email</strong>) nie znajduje się na liście uprawnionych użytkowników.</p>
                <div class="d-grid gap-2">
                    <button class="btn btn-outline-danger btn-lg rounded-pill px-4" @onclick="Logout">Wyloguj i spróbuj inne konto</button>
                </div>
            </div>
        </div>
    }
    else
    {
        <div class="page overflow-hidden">
            <NavMenu />

            <main>
                <div class="top-row px-4 d-flex justify-content-end bg-light border-bottom" style="height: 35px; font-size: 0.75rem;">
                    <span class="text-success small me-3 d-flex align-items-center"><i class="bi bi-cloud-check-fill me-1"></i> Firebase Połączony</span>
                    @if (remainingTokens >= 0)
                    {
                        <span class="text-info small d-flex align-items-center"><i class="bi bi-cpu-fill me-1"></i> Gemma 3: @(modelLimit - remainingTokens) / @(modelLimit >= 1000 ? (modelLimit / 1000.0).ToString("0.#") + "K" : modelLimit.ToString())</span>
                    }
                </div>

                <article class="content px-0 overflow-auto" style="height: calc(100vh - 35px);">
                    @Body
                </article>
            </main>
        </div>
    }
}
else
{
    <div class="d-flex justify-content-center align-items-center" style="height: 100vh; background: #f8f9fa;">
        <div class="text-center">
            <div class="spinner-border text-primary shadow-sm" style="width: 3rem; height: 3rem;" role="status"></div>
            <p class="mt-3 text-muted fw-bold animate__animated animate__pulse animate__infinite">Inicjalizacja systemu...</p>
        </div>
    </div>
}


@code {
    private bool isInitialized = false;
    private int remainingTokens = -1;
    private int modelLimit = 14400;
    private DotNetObjectReference<MainLayout>? objRef;
    
    private FirebaseUser? currentUser;
    private bool isWhitelisted = false;

    [JSInvokable]
    public async Task RefreshTokens()
    {
        remainingTokens = await GeminiService.GetRemainingRequestsAsync();
        modelLimit = await GeminiService.GetModelLimitAsync();
        StateHasChanged();
    }

    private Action<FirebaseUser?>? authHandler;

    protected override async Task OnInitializedAsync()
    {
        try
        {
            var config = await Http.GetFromJsonAsync<System.Text.Json.JsonElement>("firebase_config.json");
            if (config.ValueKind != System.Text.Json.JsonValueKind.Undefined)
            {
                authHandler = (user) => InvokeAsync(() => HandleAuthStateChanged(user));
                FirebaseService.OnAuthStateChanged += authHandler;
                await FirebaseService.InitializeAsync(config);
                
                // Wait for auth to settle
                currentUser = await FirebaseService.WaitForAuthAsync();
                if (currentUser != null)
                {
                    isWhitelisted = await FirebaseService.IsEmailWhitelistedAsync(currentUser.Email);
                }
                
                if (config.TryGetProperty("geminiApiKey", out var apiKeyProp))
                {
                    await GeminiService.InitializeAsync(apiKeyProp.GetString() ?? "");
                    remainingTokens = await GeminiService.GetRemainingRequestsAsync();
                    modelLimit = await GeminiService.GetModelLimitAsync();
                }

                isInitialized = true;
                StateHasChanged();
                
                objRef = DotNetObjectReference.Create(this);
                await JSRuntime.InvokeVoidAsync("geminiService.registerRefreshHandler", objRef);
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Initialization error: {ex.Message}");
        }
    }

    private async void HandleAuthStateChanged(FirebaseUser? user)
    {
        currentUser = user;
        if (currentUser != null)
        {
            isWhitelisted = await FirebaseService.IsEmailWhitelistedAsync(currentUser.Email);
        }
        else
        {
            isWhitelisted = false;
        }

        StateHasChanged();
        
        if (currentUser == null)
        {
            NavigationManager.NavigateTo("/");
        }
    }

    private async Task Login()
    {
        try 
        {
            currentUser = await FirebaseService.LoginWithGoogleAsync();
            if (currentUser != null)
            {
                isWhitelisted = await FirebaseService.IsEmailWhitelistedAsync(currentUser.Email);
            }
            StateHasChanged();
        }
        catch (Exception ex)
        {
            await JSRuntime.InvokeVoidAsync("alert", $"Błąd logowania: {ex.Message}");
        }
    }

    private async Task Logout()
    {
        await FirebaseService.LogoutAsync();
        // Redirect will happen via HandleAuthStateChanged
    }

    public void Dispose()
    {
        if (authHandler != null)
        {
            FirebaseService.OnAuthStateChanged -= authHandler;
        }
        objRef?.Dispose();
    }
}
