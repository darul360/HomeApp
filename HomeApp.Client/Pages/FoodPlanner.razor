@page "/food-planner"
@using HomeApp.Client.Models
@using HomeApp.Client.Services
@using System.Text.Json
@inject IFirebaseService FirebaseService
@inject IGeminiService GeminiService
@inject IJSRuntime JSRuntime
@inject NavigationManager NavigationManager

<div class="container-fluid px-4 mt-4">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h2 class="m-0 fw-bold text-dark">Planer Jedzenia 🍎</h2>
    </div>
</div>

<div class="container-fluid px-4">
    <div class="row g-4">
        <!-- LEWO: Formularz wejściowy -->
        <div class="col-lg-7">
            <div class="modern-card mb-4" style="border-top: 4px solid #34a853;">
                <h5 class="fw-bold mb-3"><i class="bi bi-fridge me-2"></i> Co masz w lodówce?</h5>
                <div class="mb-3">
                    <label class="form-label text-muted small">Wpisz produkty po przecinku lub spacji</label>
                    <textarea class="form-control modern-input mb-2" @bind="fridgeContents" 
                              placeholder="np. kurczak, ryż, brokuły, jajka, jogurt..." style="height: 120px;"></textarea>
                    
                    <div class="text-center my-2 position-relative">
                        <hr class="opacity-25" />
                        <span class="position-absolute top-50 start-50 translate-middle bg-white px-3 text-muted small fw-bold">ALBO</span>
                    </div>

                    <div class="mb-3">
                        <label class="btn btn-outline-secondary w-100 rounded-pill py-2 @(isProcessingOcr ? "disabled" : "")">
                            @if (isProcessingOcr)
                            {
                                <span class="spinner-border spinner-border-sm me-2"></span>
                                <span>Przetwarzanie paragonu...</span>
                            }
                            else
                            {
                                <i class="bi bi-camera me-2"></i><span>Dodaj zdjęcia paragonów</span>
                            }
                            <InputFile OnChange="HandleReceiptUpload" hidden disabled="@isProcessingOcr" accept="image/*" />
                        </label>
                    </div>

                    <button class="btn btn-primary rounded-pill px-4 shadow-sm w-100" @onclick="StartWizard" disabled="@(string.IsNullOrWhiteSpace(fridgeContents) || isGenerating)">
                        <i class="bi bi-magic me-2"></i> Wygeneruj jadłospis
                    </button>
                </div>
            </div>

            @if (currentGeneratedPlan != null)
            {
                <div class="modern-card animate__animated animate__fadeIn">
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <h5 class="fw-bold m-0 text-primary">Twój Nowy Jadłospis</h5>
                        <div class="d-flex gap-2">
                            <button class="btn btn-sm btn-outline-danger border-0" @onclick="ToggleFavoriteCurrent">
                                <i class="bi @(currentGeneratedPlan.IsFavorite ? "bi-heart-fill text-danger" : "bi-heart") fs-5"></i>
                            </button>
                            <button class="btn btn-sm btn-outline-primary rounded-pill px-3" @onclick="ExportToPdf" disabled="@(isGenerating || isExporting)">
                                @if (isExporting)
                                {
                                    <span class="spinner-border spinner-border-sm me-1" role="status"></span>
                                }
                                <i class="bi bi-file-pdf me-1"></i> 
                                @(isExporting ? "Generowanie..." : "PDF")
                            </button>
                            <button class="btn btn-sm btn-success rounded-pill px-3" @onclick="SavePlan">
                                <i class="bi bi-cloud-check me-1"></i> Zapisz
                            </button>
                        </div>
                    </div>

                    <div class="row g-3 mb-4">
                        <div class="col-md-12">
                            <div class="p-3 bg-light rounded border border-light shadow-sm">
                                <h6 class="small fw-bold text-muted mb-2"><i class="bi bi-list-check me-1"></i> Wykryte składniki:</h6>
                                <div class="d-flex flex-wrap gap-2">
                                    @foreach (var ing in detectedIngredients)
                                    {
                                        <span class="badge bg-white text-dark border rounded-pill px-3 shadow-sm">@ing</span>
                                    }
                                </div>
                            </div>
                        </div>
                    </div>

                    <div id="mealPlanExportArea" class="meal-content p-4 bg-white rounded border shadow-sm" style="line-height: 1.8;">
                        @((MarkupString)Markdig.Markdown.ToHtml(currentGeneratedPlan.Content))
                    </div>
                </div>
            }
        </div>

        <!-- PRAWO: Lista zapisanych -->
        <div class="col-lg-5">
            <div class="modern-card h-100">
                <h5 class="fw-bold mb-4"><i class="bi bi-journal-check me-2"></i> Zapisane jadłospisy</h5>
                
                @if (savedPlans == null)
                {
                    <div class="text-center py-5">
                        <div class="spinner-border text-muted"></div>
                    </div>
                }
                else if (!(savedPlans?.Any() ?? false))
                {
                    <div class="text-center py-5 text-muted">
                        <i class="bi bi-calendar-x fs-1 opacity-25"></i>
                        <p class="mt-3">Brak zapisanych jadłospisów.</p>
                    </div>
                }
                else
                {
                    <div class="list-group list-group-flush">
                        @foreach (var plan in savedPlans)
                        {
                            <div class="list-group-item border-0 px-0 mb-3 bg-transparent">
                                <div class="modern-card m-0 p-3 shadow-sm hover-shadow transition cursor-pointer @(selectedPlanId == plan.Id ? "border-primary border-2" : "")" 
                                     @onclick="() => LoadSavedPlan(plan)" @ondblclick="() => StartEditing(plan)">
                                    <div class="d-flex justify-content-between align-items-center">
                                        <div class="text-truncate" style="max-width: 70%;">
                                            @if (editingPlanId == plan.Id)
                                            {
                                                <input class="form-control form-control-sm mb-1" @bind="editingTitle" @onclick:stopPropagation="true" 
                                                       @onblur="() => SaveEditedTitle(plan)" @onkeyup="(e) => HandleRenameKey(e, plan)" autofocus />
                                            }
                                            else
                                            {
                                                <h6 class="fw-bold mb-1">@plan.Title</h6>
                                            }
                                            <small class="text-muted">@plan.CreatedDate.ToShortDateString() • @plan.Days dni</small>
                                        </div>
                                        <div class="d-flex gap-2">
                                            <button class="btn btn-link p-0 text-danger text-decoration-none" @onclick:stopPropagation="true" @onclick="() => ToggleFavoriteSaved(plan)">
                                                <i class="bi @(plan.IsFavorite ? "bi-heart-fill" : "bi-heart")"></i>
                                            </button>
                                            <button class="btn btn-link p-0 text-muted" @onclick:stopPropagation="true" @onclick="() => DeletePlan(plan)">
                                                <i class="bi bi-trash"></i>
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        }
                    </div>
                }
            </div>
        </div>
    </div>
</div>

<!-- WIZARD MODAL -->
@if (showWizard)
{
    <div class="modal fade show d-block" style="background: rgba(0,0,0,0.5); z-index: 1050;">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content shadow-lg border-0" style="border-radius: 15px;">
                @if (wizardStep == 1)
                {
                    <div class="modal-header bg-success text-white border-0 py-3 px-4" style="border-radius: 15px 15px 0 0;">
                        <h5 class="modal-title fw-bold m-0">Krok 1: Czas trwania</h5>
                        <button type="button" class="btn-close btn-close-white" @onclick="() => showWizard = false"></button>
                    </div>
                    <div class="modal-body p-4 text-center">
                        <p class="text-muted mb-4">Na ile dni chcesz wygenerować jadłospis?</p>
                        <div class="d-grid gap-3">
                            <button class="btn btn-outline-success py-3 rounded-3 @(wizardDays == 1 ? "active bg-success text-white" : "")" @onclick="() => wizardDays = 1">
                                <h6 class="m-0 fw-bold">1 Dzień</h6>
                                <small>Szybki plan "na teraz"</small>
                            </button>
                            <button class="btn btn-outline-success py-3 rounded-3 @(wizardDays == 7 ? "active bg-success text-white" : "")" @onclick="() => wizardDays = 7">
                                <h6 class="m-0 fw-bold">7 Dni (Tydzień)</h6>
                                <small>Pełny plan zakupowy</small>
                            </button>
                            <div class="input-group">
                                <span class="input-group-text bg-white border-end-0 text-muted">Inna ilość dni (1-14):</span>
                                <input type="number" class="form-control border-start-0" @bind="wizardDays" min="1" max="14" />
                            </div>
                        </div>
                    </div>
                    <div class="modal-footer border-0 p-4">
                        <button class="btn btn-light rounded-pill px-4" @onclick="() => showWizard = false">Anuluj</button>
                        <button class="btn btn-success rounded-pill px-5 shadow-sm" @onclick="() => wizardStep = 2">Dalej <i class="bi bi-arrow-right ms-2"></i></button>
                    </div>
                }
                else if (wizardStep == 2)
                {
                    <div class="modal-header bg-primary text-white border-0 py-3 px-4" style="border-radius: 15px 15px 0 0;">
                        <h5 class="modal-title fw-bold m-0">Krok 2: Preferencje</h5>
                        <button type="button" class="btn-close btn-close-white" @onclick="() => showWizard = false"></button>
                    </div>
                    <div class="modal-body p-4">
                        <p class="text-muted mb-4 text-center">Jakie przepisy preferujesz?</p>
                        <div class="row g-3">
                            @foreach (var pref in new[] { "Szybkie", "Tanie", "Czasochłonne (Gourmet)", "Dietetyczne" })
                            {
                                <div class="col-6">
                                    <button class="btn btn-outline-primary w-100 py-3 rounded-3 @(wizardPreference == pref ? "active bg-primary text-white" : "")" 
                                            @onclick="() => wizardPreference = pref">
                                        @pref
                                    </button>
                                </div>
                            }
                        </div>
                        <div class="mt-4">
                            <label class="form-label small text-muted">Dodatkowe uwagi (diety, alergie):</label>
                            <input type="text" class="form-control modern-input" @bind="wizardCustomNotes" placeholder="np. bez glutenu, dieta keto..." />
                        </div>
                    </div>
                    <div class="modal-footer border-0 p-4">
                        <button class="btn btn-light rounded-pill px-4" @onclick="() => wizardStep = 1">Cofnij</button>
                        <button class="btn btn-primary rounded-pill px-5 shadow-sm" @onclick="() => wizardStep = 3">Dalej <i class="bi bi-arrow-right ms-2"></i></button>
                    </div>
                }
                else if (wizardStep == 3)
                {
                    <div class="modal-header bg-info text-white border-0 py-3 px-4" style="border-radius: 15px 15px 0 0;">
                        <h5 class="modal-title fw-bold m-0">Krok 3: Liczba osób</h5>
                        <button type="button" class="btn-close btn-close-white" @onclick="() => showWizard = false"></button>
                    </div>
                    <div class="modal-body p-4 text-center">
                        <p class="text-muted mb-4">Dla ilu osób przygotować jadłospis?</p>
                        <div class="d-grid gap-3">
                            <button class="btn btn-outline-info py-3 rounded-3 @(wizardPeople == 1 && !isCustomPeople ? "active bg-info text-white" : "")" 
                                    @onclick="() => { wizardPeople = 1; isCustomPeople = false; }">
                                <h6 class="m-0 fw-bold">1 Osoba</h6>
                            </button>
                            <button class="btn btn-outline-info py-3 rounded-3 @(wizardPeople == 2 && !isCustomPeople ? "active bg-info text-white" : "")" 
                                    @onclick="() => { wizardPeople = 2; isCustomPeople = false; }">
                                <h6 class="m-0 fw-bold">2 Osoby</h6>
                            </button>
                            <button class="btn btn-outline-info py-3 rounded-3 @(isCustomPeople ? "active bg-info text-white" : "")" 
                                    @onclick="() => isCustomPeople = true">
                                <h6 class="m-0 fw-bold">Inna liczba osób</h6>
                            </button>
                            
                            @if (isCustomPeople)
                            {
                                <div class="input-group animate__animated animate__fadeIn">
                                    <span class="input-group-text bg-white border-end-0 text-muted">Podaj liczbę:</span>
                                    <input type="number" class="form-control border-start-0" @bind="wizardPeople" min="1" max="20" />
                                </div>
                            }
                        </div>
                    </div>
                    <div class="modal-footer border-0 p-4">
                        <button class="btn btn-light rounded-pill px-4" @onclick="() => wizardStep = 2">Cofnij</button>
                        <button class="btn btn-primary rounded-pill px-5 shadow-sm" @onclick="GenerateMenu" disabled="@isGenerating">
                            Generuj Jadłospis!
                        </button>
                    </div>
                }
                else if (wizardStep == 4)
                {
                    <div class="modal-header bg-primary text-white border-0 py-3 px-4" style="border-radius: 15px 15px 0 0;">
                        <h5 class="modal-title fw-bold m-0">Generowanie...</h5>
                    </div>
                    <div class="modal-body p-5 text-center">
                        <div class="spinner-border text-primary mb-4" style="width: 3rem; height: 3rem;"></div>
                        <h5 class="fw-bold">AI pracuje nad Twoim menu</h5>
                        <p class="text-muted">Analizuję Twoje składniki i dopasowuję przepisy do preferencji: <strong>@wizardPreference</strong>...</p>
                        <div class="progress mt-4" style="height: 10px; border-radius: 5px;">
                            <div class="progress-bar progress-bar-striped progress-bar-animated bg-primary" role="progressbar" style="width: 100%"></div>
                        </div>
                    </div>
                }
            </div>
        </div>
    </div>
}

<style>
    .hover-shadow:hover {
        transform: translateY(-3px);
        box-shadow: 0 0.5rem 1rem rgba(0, 0, 0, 0.15) !important;
    }
    .transition {
        transition: all 0.2s ease-in-out;
    }
    .cursor-pointer {
        cursor: pointer;
    }
    .meal-content h1, .meal-content h2, .meal-content h3 {
        color: #1a73e8;
        font-weight: 700;
        margin-top: 2rem;
        margin-bottom: 1rem;
        border-bottom: 2px solid #e8f0fe;
        padding-bottom: 0.5rem;
    }
    .meal-content h4 {
        color: #34a853;
        font-weight: 600;
        margin-top: 1.5rem;
    }
    .meal-content ul {
        list-style: none;
        padding-left: 0;
    }
    .meal-content li {
        padding: 0.5rem 0;
        border-bottom: 1px solid #f1f3f4;
        display: flex;
        align-items: center;
    }
    .meal-content li::before {
        content: "•";
        color: #34a853;
        font-weight: bold;
        display: inline-block;
        width: 1.5rem;
        font-size: 1.2rem;
    }
    .meal-content table {
        width: 100%;
        margin: 1.5rem 0;
        border-collapse: separate;
        border-spacing: 0;
        border-radius: 12px;
        overflow: hidden;
        box-shadow: 0 4px 12px rgba(0,0,0,0.05);
        border: 1px solid #e8eaed;
    }
    .meal-content th {
        background: #f8f9fa;
        color: #5f6368;
        font-weight: 600;
        text-transform: uppercase;
        font-size: 0.75rem;
        letter-spacing: 0.5px;
        padding: 1rem;
    }
    .meal-content td {
        padding: 1rem;
        border-top: 1px solid #e8eaed;
        background: white;
    }
    .meal-day-card {
        background: #fdfdfd;
        border-radius: 15px;
        padding: 1.5rem;
        margin-bottom: 1.5rem;
        border-left: 5px solid #4285f4;
        box-shadow: 0 2px 8px rgba(0,0,0,0.03);
    }
    /* PDF Export Styles */
    .pdf-export-mode {
        padding: 30px !important;
        background: white !important;
        color: black !important;
        font-size: 14pt !important;
    }
    .pdf-export-mode h1, .pdf-export-mode h2, .pdf-export-mode h3 {
        margin-top: 30px !important;
        page-break-after: avoid;
    }
    .pdf-export-mode li {
        page-break-inside: avoid;
    }
</style>

@code {
    private string fridgeContents = "";
    private List<MealPlan>? savedPlans = null;
    private MealPlan? currentGeneratedPlan;
    private string selectedPlanId = "";
    private List<string> detectedIngredients = new();
    
    // Inline Editing
    private string? editingPlanId;
    private string editingTitle = "";

    // Wizard state
    private bool showWizard = false;
    private int wizardStep = 1;
    private int wizardDays = 1;
    private int wizardPeople = 1;
    private bool isCustomPeople = false;
    private string wizardPreference = "Szybkie";
    private string wizardCustomNotes = "";
    private bool isGenerating = false;
    private bool isExporting = false;
    private bool isProcessingOcr = false;
    private FirebaseUser? currentUser;

    protected override async Task OnInitializedAsync()
    {
        currentUser = await FirebaseService.GetCurrentUserAsync();
        if (currentUser != null)
        {
            await LoadPlans();
        }
    }

    private async Task LoadPlans()
    {
        if (currentUser == null) return;
        savedPlans = await FirebaseService.GetDocumentsAsync<MealPlan>("meal_plans", 100, "userId", currentUser.Id);
        savedPlans = savedPlans.OrderByDescending(p => p.CreatedDate).ToList();
    }

    private void StartWizard()
    {
        if (string.IsNullOrWhiteSpace(fridgeContents)) return;
        wizardStep = 1;
        isCustomPeople = false;
        wizardPeople = 1;
        showWizard = true;
    }

    private async Task HandleReceiptUpload(InputFileChangeEventArgs e)
    {
        if (currentUser == null || isProcessingOcr) return;
        
        try
        {
            isProcessingOcr = true;
            StateHasChanged();

            var file = e.File;
            var buffer = new byte[file.Size];
            await file.OpenReadStream(maxAllowedSize: 10 * 1024 * 1024).ReadAsync(buffer);
            var base64Data = Convert.ToBase64String(buffer);
            
            string prompt = "Wymień wszystkie produkty spożywcze (jedzenie) widoczne na tym paragonie. " + 
                            "Zwróć tylko listę produktów oddzielonych przecinkami, bez żadnego dodatkowego tekstu ani cen.";

            var result = await GeminiService.AnalyzeImageAsync(prompt, base64Data, file.ContentType);
            
            if (!string.IsNullOrWhiteSpace(result))
            {
                if (!string.IsNullOrWhiteSpace(fridgeContents))
                    fridgeContents += ", " + result.Trim();
                else
                    fridgeContents = result.Trim();
                
                await JSRuntime.InvokeVoidAsync("alert", "Produkty zostały dodane do Twojej lodówki.");
            }
        }
        catch (Exception ex)
        {
            await JSRuntime.InvokeVoidAsync("alert", $"Błąd odczytu paragonu: {ex.Message}");
        }
        finally
        {
            isProcessingOcr = false;
            StateHasChanged();
        }
    }

    private async Task GenerateMenu()
    {
        if (currentUser == null) return;
        isGenerating = true;
        wizardStep = 4;
        StateHasChanged();

        try
        {
            // Prompt construction
            string prompt = $@"Jako Master Chef i ekspert dietetyk Gemma, przygotuj WYJĄTKOWO PIĘKNY i profesjonalny jadłospis na {wizardDays} dni dla {wizardPeople} osób.
MOJA LODÓWKA: {fridgeContents}
PREFERENCJE: {wizardPreference}
DODATKOWE UWAGI: {wizardCustomNotes}
LICZBA OSÓB: {wizardPeople}

WYMAGANIA DOTYCZĄCE FORMATOWANIA:
1. Na samym początku odpowiedzi wstaw blok meta-danych (NIEPOKAZYWANY użytkownikowi bezpośrednio): 
   METADATA_START
   {{ ""INGREDIENTS"": [""składnik1"", ""składnik2""] }}
   METADATA_END
2. Następnie przygotuj jadłospis używając bogatego Markdownu:
   - Uwzględnij gramatury dopasowane do {wizardPeople} osób.
   - Używaj ikonek emoji pasujących do potraw.
   - Każdy dzień powinien być wyraźnym nagłówkiem # lub ##.
   - Używaj list punktowanych dla składników i numerowanych dla instrukcji.
   - Używaj pogrubień dla kluczowych słów.
   - Zachowaj apetyczny, entuzjastyczny ton.";

            var response = await GeminiService.AnalyzeTextAsync(prompt);
            
            // Robust Parsing
            string markdownContent = response;

            // Extract Ingredients
            if (response.Contains("METADATA_START") && response.Contains("METADATA_END"))
            {
                int start = response.IndexOf("METADATA_START") + "METADATA_START".Length;
                int end = response.IndexOf("METADATA_END");
                string metadataJson = response.Substring(start, end - start).Trim();
                
                try {
                    var meta = JsonSerializer.Deserialize<JsonElement>(metadataJson);
                    if (meta.TryGetProperty("INGREDIENTS", out var ingProp))
                    {
                        detectedIngredients = ingProp.EnumerateArray().Select(x => x.GetString() ?? "").ToList();
                    }
                } catch { 
                    detectedIngredients = fridgeContents.Split(new[] { ',', ' ' }, StringSplitOptions.RemoveEmptyEntries).ToList();
                }

                // REMOVE metadata from display content
                markdownContent = response.Substring(end + "METADATA_END".Length).Trim();
            }
            else if (response.Contains("INGREDIENTS:"))
            {
                // Fallback for old prompt style or if it didn't follow METADATA exactly
                int startIdx = response.IndexOf("[");
                int endIdx = response.IndexOf("]") + 1;
                if (startIdx >= 0 && endIdx > startIdx) {
                    string ingredientsJson = response.Substring(startIdx, endIdx - startIdx);
                    try {
                        detectedIngredients = JsonSerializer.Deserialize<List<string>>(ingredientsJson) ?? new();
                    } catch { }
                    markdownContent = response.Replace("INGREDIENTS:", "").Replace(ingredientsJson, "").Trim();
                }
            }
            else
            {
                detectedIngredients = fridgeContents.Split(new[] { ',', ' ' }, StringSplitOptions.RemoveEmptyEntries).ToList();
            }

            // Cleanup any accidental JSON showing at the top
            if (markdownContent.Trim().StartsWith("{") && markdownContent.Contains("}"))
            {
                int firstBrace = markdownContent.IndexOf("{");
                int lastBrace = markdownContent.IndexOf("}");
                if (lastBrace > firstBrace && lastBrace < 200) // Likely small JSON block
                {
                    markdownContent = markdownContent.Substring(lastBrace + 1).Trim();
                }
            }

            // Extract title from markdown
            string title = "Jadłospis " + DateTime.Now.ToShortDateString();
            var lines = markdownContent.Split('\n');
            foreach(var line in lines) {
                if(line.StartsWith("# ")) {
                    title = line.Replace("# ", "").Trim();
                    break;
                }
            }

            currentGeneratedPlan = new MealPlan
            {
                Title = title,
                Ingredients = fridgeContents,
                Preferences = $"{wizardPreference} ({wizardCustomNotes})",
                Days = wizardDays,
                Content = markdownContent,
                UserId = currentUser.Id
            };
            
            showWizard = false; // Close only on success
        }
        catch (Exception ex)
        {
            showWizard = false;
            await JSRuntime.InvokeVoidAsync("alert", $"Błąd Gemini: {ex.Message}");
        }
        finally
        {
            isGenerating = false;
            StateHasChanged();
        }
    }

    private async Task SavePlan()
    {
        if (currentGeneratedPlan == null || currentUser == null) return;
        
        bool success = await FirebaseService.AddDocumentWithIdAsync("meal_plans", currentGeneratedPlan.Id, currentGeneratedPlan);
        if (success)
        {
            await LoadPlans();
            await JSRuntime.InvokeVoidAsync("alert", "Jadłospis zapisany!");
        }
    }

    private async Task LoadSavedPlan(MealPlan plan)
    {
        if (editingPlanId != null) return; // Don't switch if editing name
        currentGeneratedPlan = plan;
        selectedPlanId = plan.Id;
        detectedIngredients = plan.Ingredients.Split(new[] { ',', ' ' }, StringSplitOptions.RemoveEmptyEntries).ToList();
    }

    private void StartEditing(MealPlan plan)
    {
        editingPlanId = plan.Id;
        editingTitle = plan.Title;
    }

    private async Task SaveEditedTitle(MealPlan plan)
    {
        if (string.IsNullOrWhiteSpace(editingTitle) || editingTitle == plan.Title)
        {
            editingPlanId = null;
            return;
        }

        string oldTitle = plan.Title;
        plan.Title = editingTitle;
        editingPlanId = null;

        bool success = await FirebaseService.AddDocumentWithIdAsync("meal_plans", plan.Id, plan);
        if (!success)
        {
            plan.Title = oldTitle; // Rollback
            await JSRuntime.InvokeVoidAsync("alert", "Błąd podczas zmiany nazwy.");
        }
        StateHasChanged();
    }

    private async Task HandleRenameKey(KeyboardEventArgs e, MealPlan plan)
    {
        if (e.Key == "Enter")
        {
            await SaveEditedTitle(plan);
        }
        else if (e.Key == "Escape")
        {
            editingPlanId = null;
        }
    }

    private async Task ToggleFavoriteCurrent()
    {
        if (currentGeneratedPlan == null) return;
        currentGeneratedPlan.IsFavorite = !currentGeneratedPlan.IsFavorite;
        // If it's already saved, update it
        if (savedPlans.Any(p => p.Id == currentGeneratedPlan.Id))
        {
            await FirebaseService.AddDocumentWithIdAsync("meal_plans", currentGeneratedPlan.Id, currentGeneratedPlan);
        }
    }

    private async Task ToggleFavoriteSaved(MealPlan plan)
    {
        plan.IsFavorite = !plan.IsFavorite;
        await FirebaseService.AddDocumentWithIdAsync("meal_plans", plan.Id, plan);
        StateHasChanged();
    }

    private async Task DeletePlan(MealPlan plan)
    {
        bool confirm = await JSRuntime.InvokeAsync<bool>("confirm", $"Usunąć jadłospis '{plan.Title}'?");
        if (confirm)
        {
            await FirebaseService.DeleteDocumentAsync("meal_plans", plan.Id);
            if (currentGeneratedPlan?.Id == plan.Id) currentGeneratedPlan = null;
            await LoadPlans();
        }
    }

    private async Task ExportToPdf()
    {
        if (currentGeneratedPlan == null) return;
        try
        {
            isExporting = true; // Use separate flag for PDF
            StateHasChanged();
            
            string filename = $"Jadlospis_{currentGeneratedPlan.Title.Replace(" ", "_")}.pdf";
            await JSRuntime.InvokeVoidAsync("pdfService.exportElementToPdf", "mealPlanExportArea", filename);
        }
        catch (Exception ex)
        {
            await JSRuntime.InvokeVoidAsync("alert", $"Błąd eksportu: {ex.Message}");
        }
        finally
        {
            isExporting = false;
            StateHasChanged();
        }
    }
}
