@page "/medical-docs"
@using HomeApp.Client.Models
@using HomeApp.Client.Services
@using System.Xml.Linq
@using LiveChartsCore
@using LiveChartsCore.SkiaSharpView
@using LiveChartsCore.SkiaSharpView.Blazor
@inject IFirebaseService FirebaseService
@inject IGeminiService GeminiService
@inject IJSRuntime JSRuntime

<div class="container-fluid px-4 mt-4">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h2 class="m-0 fw-bold text-dark">Badania Laboratoryjne</h2>
        <div class="d-flex gap-2">
            @if (testResults.Any() || pdfFile != null)
            {
                <button class="btn btn-modern @(isSaving ? "disabled" : "")" @onclick="SaveResults" disabled="@isSaving">
                    @if (isSaving)
                    {
                        <span class="spinner-border spinner-border-sm me-1"></span> <span>Zapisywanie...</span>
                    }
                    else
                    {
                        <i class="bi bi-cloud-upload"></i> <span>Zapisz w chmurze</span>
                    }
                </button>
            }
        </div>
    </div>
</div>


<div class="container-fluid px-4">
    <div class="row g-4">
        <!-- LEWO: Import i Aktualny Widok -->
        <div class="col-lg-5">
            <div class="modern-card mb-4" style="background: #fff; border: 1px solid var(--border-color); border-top: 4px solid var(--primary);">
                <h5 class="fw-bold mb-3">Nowy wpis dokumentacji</h5>
                
                <div class="mb-3">
                    <label class="form-label text-muted small">Tytuł badania (np. Morfologia 2026)</label>
                    <input type="text" class="form-control modern-input" @bind="newExaminationTitle" placeholder="Wpisz tytuł..." />
                </div>

                <div class="mb-3">
                    <label class="form-label text-muted small">Importuj wyniki (XML)</label>
                    <InputFile OnChange="@LoadXml" class="form-control modern-input" />
                </div>

                <div class="mb-3">
                    <label class="form-label text-muted small">Dodaj załącznik PDF (skan/oryginał)</label>
                    <InputFile OnChange="@HandlePdfSelection" class="form-control modern-input" accept=".pdf" />
                </div>
            </div>

            @if (testResults.Any())
            {
                <div class="modern-card">
                    <h5 class="fw-bold mb-3">Załadowane wyniki</h5>
                    <div class="table-responsive">
                        <table class="table-modern">
                            <tbody>
                                @foreach (var result in testResults)
                                {
                                    <tr>
                                        <td>
                                            <div class="fw-bold text-dark">@result.TestName</div>
                                            <small class="text-muted">@result.Date.ToShortDateString()</small>
                                        </td>
                                        <td>
                                            <span class="fs-5 fw-bold text-primary">@result.Value</span> <small class="text-muted">@result.Unit</small>
                                        </td>
                                        <td>
                                            @if (result.RangeLow != 0 || result.RangeHigh != 0)
                                            {
                                                <div class="text-center small py-1 px-2 border rounded bg-light" style="font-size: 0.85rem; color: #5f6368;">
                                                    @result.RangeLow — @result.RangeHigh
                                                </div>
                                            }
                                        </td>
                                        <td class="text-end">
                                            <div class="d-flex justify-content-end align-items-center gap-2">
                                                @if (result.RangeLow != 0 || result.RangeHigh != 0)
                                                {
                                                    @if (result.Value < result.RangeLow) { <span class="badge rounded-pill bg-warning text-dark px-3">Niskie</span> }
                                                    else if (result.Value > result.RangeHigh) { <span class="badge rounded-pill bg-danger px-3">Wysokie</span> }
                                                    else { <span class="badge rounded-pill bg-success px-3">Norma</span> }
                                                }
                                                
                                                @if (!string.IsNullOrWhiteSpace(result.Remark))
                                                {
                                                    <button class="btn btn-sm @(expandedRemarks.Contains(result.Id) ? "btn-info text-white" : "btn-outline-info shadow-sm") rounded-pill px-3 fw-bold" 
                                                            @onclick="() => ToggleRemark(result.Id)" style="min-width: 80px;">
                                                        <i class="bi @(expandedRemarks.Contains(result.Id) ? "bi-chevron-up" : "bi-chat-left-text") me-1"></i>
                                                        @(expandedRemarks.Contains(result.Id) ? "Ukryj" : "Opis")
                                                    </button>
                                                }
                                            </div>
                                        </td>
                                    </tr>
                                    @if (expandedRemarks.Contains(result.Id))
                                    {
                                        <tr class="remark-row">
                                            <td colspan="4" class="p-3 bg-light border-0">
                                                <div class="small p-3 border-start border-4 border-info bg-white rounded shadow-sm">
                                                    <strong>Uwaga diagnostyczna:</strong><br/>
                                                    @result.Remark
                                                </div>
                                            </td>
                                        </tr>
                                    }
                                }
                            </tbody>
                        </table>
                    </div>
                </div>
            }

            <!-- Archiwum PDF - Moved here -->
            <div class="modern-card mt-4">
                <h5 class="fw-bold mb-3">Archiwum dokumentów PDF</h5>
                <div class="table-responsive">
                    <table class="table-modern">
                        <thead>
                            <tr class="bg-transparent border-0">
                                <th class="text-muted small">Tytuł dokumentu</th>
                                <th class="text-muted small">Data</th>
                                <th class="text-muted small text-center">AI</th>
                                <th class="text-muted small text-end">Akcje</th>
                            </tr>
                        </thead>
                        <tbody>
                            @foreach (var doc in medicalDocuments)
                            {
                                <tr>
                                    <td class="fw-bold">@doc.Title</td>
                                    <td>@doc.Date.ToShortDateString()</td>
                                    <td class="text-center">
                                        <button @onclick="() => AnalyzeDocument(doc)" class="btn btn-outline-info btn-sm rounded-pill px-2 shadow-sm" title="Analiza AI">
                                            <i class="bi bi-robot"></i>
                                        </button>
                                    </td>
                                    <td class="text-end">
                                        <div class="d-flex justify-content-end gap-2">
                                            <button @onclick='() => PreviewPdf(doc.PdfBase64, doc.Title)' class="btn btn-outline-primary btn-sm rounded-pill px-3 shadow-sm">
                                                <i class="bi bi-eye"></i> Podgląd
                                            </button>
                                            <button @onclick='() => DownloadPdf(doc.PdfBase64, doc.Title, "download")' class="btn btn-outline-dark btn-sm rounded-pill px-3 shadow-sm">
                                                <i class="bi bi-download"></i> Pobierz
                                            </button>
                                            <button @onclick="() => DeleteDocument(doc.Id)" class="btn btn-link text-danger p-0" title="Usuń dokument">
                                                <i class="bi bi-trash3"></i>
                                            </button>
                                        </div>
                                    </td>
                                </tr>
                            }
                            @if (!medicalDocuments.Any())
                            {
                                <tr>
                                    <td colspan="3" class="text-center text-muted py-4">Brak zapisanych dokumentów PDF.</td>
                                </tr>
                            }
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- PRAWO: Historia i Baza -->
        <div class="col-lg-7">
            <div class="modern-card">
                <div class="d-flex justify-content-between align-items-center mb-4">
                    <h5 class="fw-bold m-0">Historia badań</h5>
                    <div style="width: 280px;">
                        <input type="text" class="form-control modern-input shadow-sm" placeholder="Szukaj po nazwie..." 
                               @bind="dbSearchTerm" @bind:event="oninput" />
                    </div>
                </div>

                <div>
                    <table class="table-modern" style="table-layout: fixed;">
                        <thead>
                            <tr class="bg-transparent border-0">
                                <th class="text-muted small" style="width: 30%;">Badanie</th>
                                <th class="text-muted small text-center" style="width: 15%;">Wynik</th>
                                <th class="text-muted small text-center" style="width: 15%;">Zakres</th>
                                <th class="text-muted small" style="width: 15%;">Data</th>
                                <th class="text-muted small text-center" style="width: 10%;">AI</th>
                                <th class="text-muted small text-end" style="width: 15%;">Opis</th>
                            </tr>
                        </thead>
                        <tbody>
                            @foreach (var result in PaginatedDbResults)
                            {
                                <tr>
                                    <td class="fw-bold text-truncate" title="@result.TestName">@result.TestName</td>
                                    <td class="text-center">@result.Value <small class="text-muted">@result.Unit</small></td>
                                    <td class="text-center">
                                        @if (result.RangeLow != 0 || result.RangeHigh != 0)
                                        {
                                            <span class="text-muted" style="font-size: 0.9rem;">
                                                @result.RangeLow — @result.RangeHigh
                                            </span>
                                        }
                                    </td>
                                    <td>@result.Date.ToShortDateString()</td>
                                    <td class="text-center">
                                        <button class="btn btn-outline-info btn-sm rounded-pill px-2 py-0 shadow-sm" 
                                                @onclick="() => AnalyzeResult(result)" title="Analiza AI">
                                            <i class="bi bi-robot"></i>
                                        </button>
                                    </td>
                                    <td class="text-end">
                                        <div class="d-flex justify-content-end align-items-center gap-2">
                                            @if (result.RangeLow != 0 || result.RangeHigh != 0)
                                            {
                                                @if (result.Value < result.RangeLow) { <span class="badge rounded-pill bg-warning text-dark px-2">L</span> }
                                                else if (result.Value > result.RangeHigh) { <span class="badge rounded-pill bg-danger px-2">H</span> }
                                                else { <span class="badge rounded-pill bg-success px-2">N</span> }
                                            }
                                            @if (!string.IsNullOrWhiteSpace(result.Remark))
                                            {
                                                <button class="btn @(expandedRemarks.Contains(result.Id) ? "btn-secondary" : "btn-outline-primary") btn-sm rounded-pill px-3 py-0 fw-bold shadow-sm"
                                                        @onclick="() => ToggleRemark(result.Id)" style="font-size: 0.75rem;">
                                                    @(expandedRemarks.Contains(result.Id) ? "Zamknij" : "Opis")
                                                </button>
                                            }
                                        </div>
                                    </td>
                                </tr>
                                @if (expandedRemarks.Contains(result.Id))
                                {
                                    <tr>
                                        <td colspan="5" class="p-2 bg-light">
                                            <div class="small p-2" style="white-space: pre-wrap; word-break: break-word;">@result.Remark</div>
                                        </td>
                                    </tr>
                                }
                            }
                        </tbody>
                    </table>
                </div>

                @if (TotalPages > 1)
                {
                    <div class="d-flex justify-content-between align-items-center mt-4">
                        <small class="text-muted">Strona @CurrentPage z @TotalPages (@FilteredDbResults.Count() wyników)</small>
                        <nav>
                            <ul class="pagination pagination-sm m-0 gap-1">
                                <li class="page-item @(CurrentPage == 1 ? "disabled" : "")">
                                    <button class="page-link border-0 rounded-circle shadow-sm" @onclick="() => ChangePage(CurrentPage - 1)">
                                        <i class="bi bi-chevron-left"></i>
                                    </button>
                                </li>
                                
                                @for (int i = 1; i <= TotalPages; i++)
                                {
                                    int pageNum = i;
                                    <li class="page-item @(CurrentPage == pageNum ? "active" : "")">
                                        <button class="page-link border-0 rounded-pill shadow-sm px-3 @(CurrentPage == pageNum ? "" : "bg-white text-dark")" 
                                                @onclick="() => ChangePage(pageNum)">
                                            @pageNum
                                        </button>
                                    </li>
                                }

                                <li class="page-item @(CurrentPage == TotalPages ? "disabled" : "")">
                                    <button class="page-link border-0 rounded-circle shadow-sm" @onclick="() => ChangePage(CurrentPage + 1)">
                                        <i class="bi bi-chevron-right"></i>
                                    </button>
                                </li>
                            </ul>
                        </nav>
                    </div>
                }
            </div>
        </div>
    </div>
</div>

<!-- Modal Podglądu PDF -->
@if (showPreviewModal)
{
    <div class="modal fade show d-block" style="background: rgba(0,0,0,0.5); z-index: 1050;">
        <div class="modal-dialog modal-xl modal-dialog-centered" style="max-height: 90vh;">
            <div class="modal-content shadow-lg border-0" style="border-radius: 15px; overflow: hidden;">
                <div class="modal-header bg-white border-0 py-3 px-4 d-flex justify-content-between align-items-center">
                    <h5 class="modal-title fw-bold text-dark m-0">@previewTitle</h5>
                    <button type="button" class="btn-close" @onclick="ClosePreview"></button>
                </div>
                <div class="modal-body p-0" style="height: 80vh;">
                    @if (!string.IsNullOrEmpty(previewUrl))
                    {
                        <iframe src="@previewUrl" class="w-100 h-100 border-0"></iframe>
                    }
                    else
                    {
                        <div class="d-flex flex-column align-items-center justify-content-center h-100 text-muted">
                            <span class="spinner-border mb-3"></span>
                            <span>Trwa ładowanie dokumentu...</span>
                        </div>
                    }
                </div>
                <div class="modal-footer bg-light border-0 py-2 px-4">
                    <button class="btn btn-secondary rounded-pill px-4" @onclick="ClosePreview">Zamknij</button>
                    @if (!string.IsNullOrEmpty(previewBase64))
                    {
                        <button class="btn btn-modern rounded-pill px-4" @onclick='() => DownloadPdf(previewBase64, previewTitle, "download")'>
                            <i class="bi bi-download me-1"></i> Pobierz PDF
                        </button>
                    }
                </div>
            </div>
        </div>
    </div>
}



<!-- Modal Analizy AI -->
@if (showAiModal)
{
    <div class="modal fade show d-block" style="background: rgba(0,0,0,0.5); z-index: 1060;">
        <div class="modal-dialog modal-lg modal-dialog-centered">
            <div class="modal-content shadow-lg border-0" style="border-radius: 15px;">
                <div class="modal-header bg-info text-white border-0 py-3 px-4" style="border-radius: 15px 15px 0 0;">
                    <h5 class="modal-title fw-bold m-0"><i class="bi bi-robot me-2"></i> Analiza Medyczna AI</h5>
                    <button type="button" class="btn-close btn-close-white" @onclick="() => showAiModal = false"></button>
                </div>
                <div class="modal-body p-4" style="max-height: 70vh; overflow-y: auto;">
                    @if (isAnalyzing)
                    {
                        <div class="d-flex flex-column align-items-center justify-content-center py-5">
                            <div class="spinner-border text-info mb-3" style="width: 3rem; height: 3rem;"></div>
                            <p class="text-muted">Gemini analizuje Twoje dane... Proszę czekać.</p>
                        </div>
                    }
                    else
                    {
                        <div class="ai-response-container" style="white-space: pre-wrap; line-height: 1.6; color: #3c4043;">
                            @aiResponse
                        </div>
                        <div class="mt-4 p-3 bg-light rounded border-start border-4 border-warning">
                            <small class="text-muted">
                                <i class="bi bi-exclamation-triangle-fill me-1"></i>
                                <strong>Ważne:</strong> Ta analiza została wygenerowana przez sztuczną inteligencję. Nie zastępuje ona profesjonalnej porady lekarskiej. Zawsze skonsultuj wyniki badań ze swoim lekarzem.
                            </small>
                        </div>
                    }
                </div>
                <div class="modal-footer border-0 py-3 px-4">
                    <button class="btn btn-secondary rounded-pill px-4" @onclick="() => showAiModal = false">Zamknij</button>
                </div>
            </div>
        </div>
    </div>
}

@code {
    private List<TestResult> testResults = new();
    private List<TestResult> dbResults = new();
    private List<MedicalDocument> medicalDocuments = new();
    private HashSet<string> expandedRemarks = new();
    private string dbSearchTerm = "";
    private string newExaminationTitle = "";
    private IBrowserFile? pdfFile;
    private bool isSaving = false;
    private bool showPreviewModal = false;
    private string previewUrl = "";
    private string previewTitle = "";
    private string previewBase64 = "";
    private int CurrentPage = 1;
    private int PageSize = 10;
    
    private bool isAnalyzing = false;
    private bool showAiModal = false;
    private string aiResponse = "";
    
    private FirebaseUser? currentUser;

    public ISeries[] Series { get; set; } = Array.Empty<ISeries>();

    private IEnumerable<TestResult> FilteredDbResults => 
        string.IsNullOrWhiteSpace(dbSearchTerm) 
            ? dbResults 
            : dbResults.Where(r => r.TestName.Contains(dbSearchTerm, StringComparison.OrdinalIgnoreCase));

    private IEnumerable<TestResult> PaginatedDbResults =>
        FilteredDbResults.Skip((CurrentPage - 1) * PageSize).Take(PageSize);

    private int TotalPages => (int)Math.Ceiling((double)FilteredDbResults.Count() / PageSize);

    private void ChangePage(int page)
    {
        CurrentPage = page;
        expandedRemarks.Clear();
    }

    protected override async Task OnInitializedAsync()
    {
        currentUser = await FirebaseService.GetCurrentUserAsync();
        if (currentUser != null)
        {
            await LoadHistory();
        }
    }

    private async Task LoadHistory()
    {
        if (currentUser == null) return;
        
        dbResults = await FirebaseService.GetDocumentsAsync<TestResult>("test_results", 100, "userId", currentUser.Id);
        dbResults = dbResults.OrderByDescending(r => r.Date).ToList();
        
        medicalDocuments = await FirebaseService.GetDocumentsAsync<MedicalDocument>("medical_documents", 50, "userId", currentUser.Id);
        medicalDocuments = medicalDocuments.OrderByDescending(d => d.Date).ToList();
    }

    private void ToggleRemark(string id)
    {
        if (expandedRemarks.Contains(id)) expandedRemarks.Remove(id);
        else expandedRemarks.Add(id);
    }

    private async Task LoadXml(InputFileChangeEventArgs e)
    {
        try 
        {
            var file = e.File;
            using var stream = file.OpenReadStream(1024000);
            var doc = await XDocument.LoadAsync(stream, LoadOptions.None, CancellationToken.None);

            testResults.Clear();
            var culture = System.Globalization.CultureInfo.GetCultureInfo("pl-PL");

            foreach (var parameter in doc.Descendants("parameter"))
            {
                var label = parameter.Element("label")?.Value ?? "Unknown";
                var valueStr = parameter.Element("value")?.Value;
                var lowStr = parameter.Element("low")?.Value;
                var highStr = parameter.Element("high")?.Value;
                var unit = parameter.Element("unit")?.Value ?? "";

                if (string.IsNullOrEmpty(valueStr)) continue;

                var result = new TestResult
                {
                    TestName = label,
                    Unit = unit,
                    Date = DateTime.Now,
                    Remark = parameter.Element("remark_all")?.Value
                };

                result.Value = ParseMedicalValue(valueStr, culture);
                result.RangeLow = ParseMedicalValue(lowStr, culture);
                result.RangeHigh = ParseMedicalValue(highStr, culture);

                if (result.Value != 0 || !string.IsNullOrEmpty(label))
                {
                    testResults.Add(result);
                }
            }
            StateHasChanged();
        }
        catch (Exception ex)
        {
            await JSRuntime.InvokeVoidAsync("alert", $"Błąd podczas wczytywania XML: {ex.Message}");
        }
    }

    private double ParseMedicalValue(string? input, System.Globalization.CultureInfo culture)
    {
        if (string.IsNullOrEmpty(input)) return 0;
        var cleaned = new string(input.Where(c => char.IsDigit(c) || c == ',' || c == '.').ToArray());
        if (double.TryParse(cleaned.Replace(".", ","), System.Globalization.NumberStyles.Any, culture, out var val))
        {
            return val;
        }
        return 0;
    }

    private void HandlePdfSelection(InputFileChangeEventArgs e)
    {
        pdfFile = e.File;
        StateHasChanged();
    }

    private async Task SaveResults()
    {
        if (isSaving) return;
        
        try 
        {
            isSaving = true;
            string? pdfBase64 = null;
            
            if (pdfFile != null)
            {
                using var stream = pdfFile.OpenReadStream(20 * 1024 * 1024); // Allow up to 20MB for processing
                using var ms = new MemoryStream();
                await stream.CopyToAsync(ms);
                pdfBase64 = Convert.ToBase64String(ms.ToArray());

                // Compression if over 1MB
                if (ms.Length > 1000000)
                {
                    pdfBase64 = await JSRuntime.InvokeAsync<string>("firebaseService.compressPdf", pdfBase64);
                    // Re-check size of base64 (approximate)
                    if (pdfBase64.Length * 3 / 4 > 1048576)
                    {
                        throw new Exception("Nawet po kompresji plik PDF przekracza 1MB (limit bazy danych). Spróbuj użyć mniejszego pliku.");
                    }
                }
            }

            // Save PDF entry if file or title exists
            if (!string.IsNullOrWhiteSpace(pdfBase64) || !string.IsNullOrWhiteSpace(newExaminationTitle))
            {
                var docEntry = new MedicalDocument
                {
                    Title = string.IsNullOrWhiteSpace(newExaminationTitle) ? (pdfFile?.Name ?? "Dokument bez tytułu") : newExaminationTitle,
                    PdfBase64 = pdfBase64 ?? "",
                    UserId = currentUser?.Id,
                    Date = DateTime.Now
                };
                await FirebaseService.AddDocumentAsync("medical_documents", docEntry);
            }

            foreach(var res in testResults)
            {
                res.ExaminationTitle = newExaminationTitle;
                res.PdfUrl = !string.IsNullOrEmpty(pdfBase64) ? "attached" : null; 
                res.UserId = currentUser?.Id;
                await FirebaseService.AddDocumentAsync("test_results", res);
            }
            
            testResults.Clear();
            newExaminationTitle = "";
            pdfFile = null;
            await LoadHistory();
            await JSRuntime.InvokeVoidAsync("alert", "Dane zostały pomyślnie zapisane!");
        }
        catch (Exception ex)
        {
            await JSRuntime.InvokeVoidAsync("console.error", ex.ToString());
            await JSRuntime.InvokeVoidAsync("alert", $"Błąd podczas zapisu: {ex.Message}");
        }
        finally 
        {
            isSaving = false;
            StateHasChanged();
        }
    }

    private async Task PreviewPdf(string base64, string title)
    {
        previewBase64 = base64;
        previewTitle = title;
        previewUrl = await JSRuntime.InvokeAsync<string>("firebaseService.getPdfBlobUrl", base64);
        showPreviewModal = true;
        StateHasChanged();
    }

    private async Task ClosePreview()
    {
        if (!string.IsNullOrEmpty(previewUrl))
        {
            await JSRuntime.InvokeVoidAsync("firebaseService.revokeUrl", previewUrl);
        }
        previewUrl = "";
        previewBase64 = "";
        showPreviewModal = false;
        StateHasChanged();
    }

    private async Task DeleteResult(string id)
    {
        bool confirmed = await JSRuntime.InvokeAsync<bool>("confirm", "Czy na pewno chcesz usunąć ten wynik?");
        if (!confirmed) return;

        try {
            await FirebaseService.DeleteDocumentAsync("test_results", id);
            await LoadHistory();
        } catch (Exception ex) {
            await JSRuntime.InvokeVoidAsync("alert", $"Błąd usuwania: {ex.Message}");
        }
    }

    private async Task DeleteDocument(string id)
    {
        bool confirmed = await JSRuntime.InvokeAsync<bool>("confirm", "Czy na pewno chcesz usunąć ten dokument z archiwum?");
        if (!confirmed) return;

        try {
            await FirebaseService.DeleteDocumentAsync("medical_documents", id);
            await LoadHistory();
        } catch (Exception ex) {
            await JSRuntime.InvokeVoidAsync("alert", $"Błąd usuwania: {ex.Message}");
        }
    }

    private async Task DownloadPdf(string base64, string fileName, string mode)
    {
        if (string.IsNullOrEmpty(base64)) return;
        await JSRuntime.InvokeVoidAsync("firebaseService.handleBase64Pdf", base64, fileName, mode);
    }

    private async Task AnalyzeResult(TestResult res)
    {
        showAiModal = true;
        isAnalyzing = true;
        aiResponse = "";
        StateHasChanged();

        try 
        {
            var prompt = $"Jesteś asystentem medycznym. Przeanalizuj poniższy wynik badania i powiedz co on oznacza, czy jest w normie i jakie mogą być dalsze kroki. Wynik: {res.TestName}, Wartość: {res.Value} {res.Unit}, Zakres: {res.RangeLow} - {res.RangeHigh}. Dodatkowe uwagi: {res.Remark}. Odpowiedz w języku polskim, w sposób przejrzysty i pomocny.";
            aiResponse = await GeminiService.AnalyzeTextAsync(prompt);
        }
        catch (Exception ex)
        {
            aiResponse = $"Błąd podczas analizy: {ex.Message}";
        }
        finally 
        {
            isAnalyzing = false;
            StateHasChanged();
        }
    }

    private async Task AnalyzeDocument(MedicalDocument doc)
    {
        showAiModal = true;
        isAnalyzing = true;
        aiResponse = "";
        StateHasChanged();

        try 
        {
            if (string.IsNullOrEmpty(doc.PdfBase64))
            {
                aiResponse = "Dokument nie posiada treści do analizy (brak pliku PDF).";
                return;
            }

            var prompt = "Jesteś asystentem medycznym. Przeanalizuj dołączony dokument medyczny (skan/widok PDF). Wyciągnij z niego najważniejsze informacje, zinterpretuj wyniki i podpowiedz na co zwrócić uwagę. Odpowiedz po polsku, strukturalnie i rzeczowo.";
            aiResponse = await GeminiService.AnalyzeImageAsync(prompt, doc.PdfBase64, "application/pdf");
        }
        catch (Exception ex)
        {
            aiResponse = $"Błąd podczas analizy dokumentu: {ex.Message}";
        }
        finally 
        {
            isAnalyzing = false;
            StateHasChanged();
        }
    }
}
